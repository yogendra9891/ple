var Gab={connection:null,jid_to_id:function(b){return Strophe.getBareJidFromJid(b).replace("@","-").replace(".","-")},on_roster:function(b){$(b).find("item").each(function(){var c=[],b=$(this).attr("jid"),a=$(this).attr("name")||b;15<a.length&&(a=a.substring(0,10)+"...");var e=b.split("@")[0],h=Gab.jid_to_id(b);$(this).find("group").each(function(){var f=$(this).text();c.push($(this).text());f=$("<li id='ol_"+h+"' style='display:none;cursor:pointer;clear:both;' onClick=\"openChatWindow('"+e+"&"+f+
"');\"><div class='roster-contact offline'><div class='roster-name'><input id='check_"+h+"' type='image' src = '"+site_url1+"img/online_icon.png' style='display:none;'/>"+a+"<span id='check_online_"+h+"' style='float:right; display:none;'></span></div><div class='roster-jid' style='display:none;'>"+b+"</div></div><div class='roaster-group' style='display:none;'>"+f+"</div><input type='hidden' value='"+c+"' name='section'/></li>");Gab.insert_contact(f)})});Gab.connection.addHandler(Gab.on_presence,
null,"presence");Gab.connection.send($pres())},pending_subscriber:null,on_presence:function(b){var c=$(b).attr("type"),d=$(b).attr("from"),a=Gab.jid_to_id(d),e=getSameCourseUsers(Strophe.getBareJidFromJid(d));if("subscribe"===c)Gab.pending_subscriber=d,$("#approve-jid").text(Strophe.getBareJidFromJid(d)),$("#approve_dialog").dialog("open");else if("error"!==c){var h=$("#roster-area li#"+a+" .roster-contact").removeClass("online").removeClass("away").removeClass("offline");"unavailable"===c?"logout"===
getUserStatusData(Strophe.getBareJidFromJid(d))&&(h.addClass("offline"),$("#ol_"+a).hide(),$("#check_online_"+a).hide(),$("#check_"+a).hide()):($(b).find("show").text(),"found"==e?(h.addClass("online"),$("#ol_"+a).show(),$("#check_online_"+a).show(),$("#check_"+a).show()):(h.addClass("offline"),$("#ol_"+a).hide(),$("#check_online_"+a).hide(),$("#check_"+a).hide()),$("#invite_button").show())}a=Gab.jid_to_id(d);$("#chat-"+a).data("jid",Strophe.getBareJidFromJid(d));return!0},on_roster_changed:function(b){$(b).find("item").each(function(){var c=
$(this).attr("subscription"),b=$(this).attr("jid"),a=$(this).attr("name")||b,e=Gab.jid_to_id(b);"remove"===c?$("#"+e).remove():(c="<li id='"+e+"'><div class='"+($("#"+e).attr("class")||"roster-contact offline")+"'><div class='roster-name'><input type='checkbox' value='"+Strophe.getBareJidFromJid(from)+"' name= friends[] />"+a+"</div><div class='roster-jid'>"+b+"</div></div></li>",0<$("#"+e).length?$("#"+e).replaceWith(c):Gab.insert_contact(c))});return!0},on_message:function(b){var c=$(b).attr("from"),
d=Strophe.getBareJidFromJid(c),a=Gab.jid_to_id(d);0===$("#chat-"+a).length&&($("#chat-area").tabs("add","#chat-"+a,d),$("#chat-"+a).append("<div class='chat-messages'></div><input type='text' class='chat-input'>"));$("#chat-"+a).data("jid",c);$("#chat-area").tabs("select","#chat-"+a);$("#chat-"+a+" input").focus();0<$(b).find("composing").length&&($("#chat-"+a+" .chat-messages").append("<div class='chat-event'>"+Strophe.getNodeFromJid(d)+" is typing...</div>"),Gab.scroll_chat(a));c=$(b).find("html > body");
if(0===c.length)c=$(b).find("body"),c=0<c.length?c.text():null;else{var c=c.contents(),e=$("<span></span>");c.each(function(){document.importNode?$(document.importNode(this,!0)).appendTo(e):e.append(this.xml)});c=e}c&&($("#chat-"+a+" .chat-event").remove(),$("#chat-"+a+" .chat-messages").append("<div class='chat-message'>&lt;<span class='chat-name'>"+Strophe.getNodeFromJid(d)+"</span>&gt;<span class='chat-text'></span></div>"),$("#chat-"+a+" .chat-message:last .chat-text").append(c),Gab.scroll_chat(a));
return!0},scroll_chat:function(b){b=$("#chat-"+b+" .chat-messages").get(0);b.scrollTop=b.scrollHeight},presence_value:function(b){return b.hasClass("online")?2:b.hasClass("away")?1:0},insert_contact:function(b){var c=b.find(".roster-jid").text(),d=b.find(".roaster-group").text(),a=$("#sectionsettingid").val(),e=$("#csnameid").val();if(""!=c&&""!=d)var h=getRoasterUser(c,d),f=getUserType(c,d);e.replace(/\s+/g,"");var m=Gab.presence_value(b.find(".roster-contact")),l=$("#roster-area li");if(1==a&&e==
d)if(0<l.length){var k=!1;l.each(function(){var a=Gab.presence_value($(this).find(".roster-contact")),d=$(this).find(".roster-jid").text();if(m>a||c<d)return $(this).before(b),k=!1});if(!k){var a=d.replace(/\s+/g,""),g=(f+a).replace(/\s+/g,"");$("#"+a).length||$("#roster-area ul ").append('<div id="'+a+'" class="roster-div"><p>'+d+"</p></div>");$("#"+a).length&&($("#"+g).length||$("#roster-area #"+a).append('<div id="'+g+'"><p>'+f+"</p></div>"));$("#"+a).append(b)}}else a=d.replace(/\s+/g,""),g=(f+
a).replace(/\s+/g,""),$("#"+a).length||$("#roster-area ul ").append('<div id="'+a+'" class="roster-div"><p>'+d+"</p></div>"),$("#"+a).length&&($("#"+g).length||$("#roster-area #"+a).append('<div id="'+g+'"><p>'+f+"</p></div>")),$("#"+a).append(b);2==h&&(e=e.split("-")[0],h=d.split("-")[0],e==h&&(0<l.length?(k=!1,l.each(function(){var a=Gab.presence_value($(this).find(".roster-contact")),d=$(this).find(".roster-jid").text();if(m>a||c<d)return $(this).before(b),k=!1}),k||(a=d.replace(/\s+/g,""),g=(f+
a).replace(/\s+/g,""),$("#"+a).length||$("#roster-area ul ").append('<div id="'+a+'" class="roster-div"><p>'+d+"</p></div>"),$("#"+a).length&&($("#"+g).length||$("#roster-area #"+a).append('<div id="'+g+'"><p>'+f+"</p></div>")),$("#"+g).append(b),$("#roster-area ul div.roster-div").tsort({attr:"id"}))):(a=d.replace(/\s+/g,""),g=(f+a).replace(/\s+/g,""),$("#"+a).length||$("#roster-area ul ").append('<div id="'+a+'" class="roster-div"><p>'+d+"</p></div>"),$("#"+a).length&&($("#"+g).length||$("#roster-area #"+
a).append('<div id="'+g+'"><p>'+f+"</p></div>")),$("#"+g).append(b),$("#roster-area ul div.roster-div").tsort({attr:"id"}))))}};
$(document).ready(function(){$("#contact_dialog").dialog({autoOpen:!1,draggable:!1,modal:!0,title:"Add a Contact",buttons:{Add:function(){$(document).trigger("contact_added",{jid:$("#contact-jid").val(),name:$("#contact-name").val()});$("#contact-jid").val("");$("#contact-name").val("");$(this).dialog("close")}}});$("#new-contact").click(function(b){$("#contact_dialog").dialog("open")});$("#approve_dialog").dialog({autoOpen:!1,draggable:!1,modal:!0,title:"Subscription Request",buttons:{Deny:function(){Gab.connection.send($pres({to:Gab.pending_subscriber,
type:"unsubscribed"}));Gab.pending_subscriber=null;$(this).dialog("close")},Approve:function(){Gab.connection.send($pres({to:Gab.pending_subscriber,type:"subscribed"}));Gab.connection.send($pres({to:Gab.pending_subscriber,type:"subscribe"}));Gab.pending_subscriber=null;$(this).dialog("close")}}});$("#chat-area").tabs().find(".ui-tabs-nav").sortable({axis:"x"});$(".roster-contact").live("click",function(){var b=$(this).find(".roster-jid").text(),c=$(this).find(".roster-name").text(),d=Gab.jid_to_id(b),
a=Strophe.getNodeFromJid(Gab.connection.jid);0===$("#chat-"+d).length&&($("#chat-area").tabs("add","#chat-"+d,c),$("#chat-"+d).append("<div><a target='_blank' href='"+site_url1+"users/groupchat/"+a+"/new'>Start Group Chat</a></div><div class='chat-messages'></div><input type='text' class='chat-input'>"),$("#chat-"+d).data("jid",b));$("#chat-area").tabs("select","#chat-"+d);$("#chat-"+d+" input").focus()});$(".chat-input").live("keypress",function(b){var c=$(this).parent().data("jid");if(13===b.which){b.preventDefault();
b=$(this).val();var d=$msg({to:c,type:"chat"}).c("body").t(b).up().c("active",{xmlns:"http://jabber.org/protocol/chatstates"});Gab.connection.send(d);$(this).parent().find(".chat-messages").append("<div class='chat-message'>&lt;<span class='chat-name me'>"+Strophe.getNodeFromJid(Gab.connection.jid)+"</span>&gt;<span class='chat-text'>"+b+"</span></div>");Gab.scroll_chat(Gab.jid_to_id(c));$(this).val("");$(this).parent().data("composing",!1)}else $(this).parent().data("composing")||(c=$msg({to:c,type:"chat"}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}),Gab.connection.send(c),$(this).parent().data("composing",!0))});$("#disconnect").click(function(){Gab.connection.disconnect();Gab.connection=null});$(window).unload(function(){Gab.connection.disconnect();Gab.connection=null});$("#chat_dialog").dialog({autoOpen:!1,draggable:!1,modal:!0,title:"Start a Chat",buttons:{Start:function(){var b=$("#chat-jid").val(),c=Gab.jid_to_id(b);$("#chat-area").tabs("add","#chat-"+c,b);$("#chat-"+c).append("<div class='chat-messages'></div><input type='text' class='chat-input'>");
$("#chat-"+c).data("jid",b);$("#chat-area").tabs("select","#chat-"+c);$("#chat-"+c+" input").focus();$("#chat-jid").val("");$(this).dialog("close")}}});$("#new-chat").click(function(){$("#chat_dialog").dialog("open")})});
$(document).bind("connect",function(b,c){var d=new Strophe.Connection(bosh_url);d.connect(c.jid,c.password,function(a){if(a===Strophe.Status.CONNECTED){$(document).trigger("connected");var b="connected"}else a===Strophe.Status.DISCONNECTED?(b="disconnected",$(document).trigger("connect",{jid:c.jid,password:c.password})):a===Strophe.Status.ERROR?(b="ERROR",$(document).trigger("connect",{jid:c.jid,password:c.password})):a===Strophe.Status.CONNFAIL&&(b="CONNFAIL",$(document).trigger("connect",{jid:c.jid,
password:c.password}));$.ajax({type:"POST",url:site_url1+"chats/generateConnectionLog",data:{response:b,jid:c.jid}}).done(function(a){})});Gab.connection=d});$(document).bind("connected",function(){var b=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});Gab.connection.sendIQ(b,Gab.on_roster);Gab.connection.addHandler(Gab.on_roster_changed,"jabber:iq:roster","iq","set");Gab.connection.addHandler(Gab.on_message,null,"message","chat")});
$(document).bind("disconnected",function(){Gab.connection=null;Gab.pending_subscriber=null;$("#roster-area ul").empty();$("#chat-area ul").empty();$("#chat-area div").remove();$("#login_dialog").dialog("open")});$(document).bind("contact_added",function(b,c){var d=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",c);Gab.connection.sendIQ(d);d=$pres({to:c.jid,type:"subscribe"});Gab.connection.send(d)});
function inviteusers(){Gab.connection.send("<message from='abhi@gajendra-pc/desktop' to='daffodil@conference.gajendra-pc'><x xmlns='http://jabber.org/protocol/muc#user'><invite to='jenis@gajendra-pc'><reason>Hey Hecate, this is the place for all good witches!</reason></invite></x></message>")};
