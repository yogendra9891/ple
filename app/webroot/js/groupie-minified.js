var usernamearay=[],Groupie={connection:null,room:null,nickname:null,NS_MUC:"http://jabber.org/protocol/muc#owner",joined:null,participants:null,jid_to_id:function(a){return Strophe.getBareJidFromJid(a).replace("@","-").replace(".","-")},on_roster:function(a){$(a).find("item").each(function(){var a=$(this).attr("jid"),c=$(this).attr("name")||a;15<c.length&&(c=c.substring(0,10)+"...");var d=Groupie.jid_to_id(a),e=$("<li id='"+d+"'><div class='roster-contact offline'><div class='roster-name'>"+c+"</div><div class='roster-jid'>"+
a+"</div></div></li>"),f=d.split("-");usernamearay.push({key:f[0],value:c});var g=[];$(this).find("group").each(function(){var e=$(this).text(),f=d.split("-");g.push($(this).text());var k=a.split("@")[0],e=$("<li style='display:none;' id='"+f[0]+"' ><div class='roster-contact offline'><div class='roster-name'><input id='check_"+d+"' type='checkbox' value='"+k+"@"+e+"' name= invite_friends[] /> "+c+"</div><div class='roster-jid' style='display:none;'>"+a+"</div></div><div class='roaster-group' style='display:none;'>"+
e+"</div><input type='hidden' value='"+g+"' name='section'/></li>");send_rosters_bygroup(e,Groupie.room)});Groupie.insert_contact(e)});Groupie.connection.addHandler(Groupie.on_presence_roster,null,"presence");Groupie.connection.send($pres())},on_roster_changed:function(a){$(a).find("item").each(function(){var a=$(this).attr("subscription"),c=$(this).attr("jid"),d=$(this).attr("name")||c,e=Groupie.jid_to_id(c);"remove"===a?$("#"+e).remove():(a="<li id='"+e+"'><div class='"+($("#"+e).attr("class")||
"roster-contact offline")+"'><div class='roster-name'>"+d+"</div><div class='roster-jid'>"+c+"</div></div></li>",0<$("#"+e).length?$("#"+e).replaceWith(a):Groupie.insert_contact(a))});return!0},on_presence_roster:function(a){var b=$(a).attr("type"),c=$(a).attr("from"),d=Groupie.jid_to_id(c);check_groupchat(Groupie.room);"subscribe"===b?(Groupie.pending_subscriber=c,$("#approve-jid").text(Strophe.getBareJidFromJid(c)),$("#approve_dialog").dialog("open")):"error"!==b&&(d=$("#roster-area li#"+d+" .roster-contact").removeClass("online").removeClass("away").removeClass("offline"),
"unavailable"===b?(d.addClass("offline"),a=Strophe.getBareJidFromJid(c),a=a.split("@"),a=a[0],$("#roster-area-group li#"+a+" .roster-contact").removeClass("online").addClass("offline"),$("#roster-area-group li#"+a).hide()):(a=$(a).find("show").text(),""===a||"chat"===a?(d.addClass("online"),a=getSameCourseUsers(Strophe.getBareJidFromJid(c)),"found"==a?send_online_rosters_bygroup(Strophe.getBareJidFromJid(c),Groupie.room):(a=Strophe.getBareJidFromJid(c),a=a.split("@"),a=a[0],$("#roster-area-group li#"+
a+" .roster-contact").removeClass("online").addClass("offline"),$("#roster-area-group li#"+a).hide()),d.html("<input type='checkbox' value='"+Strophe.getBareJidFromJid(c)+"' name= friends[] />"+Strophe.getBareJidFromJid(c))):(d.addClass("online"),a=getSameCourseUsers(Strophe.getBareJidFromJid(c)),"found"==a?send_online_rosters_bygroup(Strophe.getBareJidFromJid(c),Groupie.room):(a=Strophe.getBareJidFromJid(c),a=a.split("@"),a=a[0],$("#roster-area-group li#"+a+" .roster-contact").removeClass("online").addClass("offline"),
$("#roster-area-group li#"+a).hide()))),d=d.parent(),d.remove(),Groupie.insert_contact(d));d=Groupie.jid_to_id(c);$("#chat-"+d).data("jid",Strophe.getBareJidFromJid(c));return!0},presence_value:function(a){return a.hasClass("online")?2:a.hasClass("away")?1:0},insert_contact:function(a){var b=a.find(".roster-jid").text(),c=Groupie.presence_value(a.find(".roster-contact")),d=$("#roster-area li");if(0<d.length){var e=!1;d.each(function(){var d=Groupie.presence_value($(this).find(".roster-contact")),
g=$(this).find(".roster-jid").text();if(c>d||b<g)return $(this).before(a),e=!0,!1});e||$("#roster-area ul").append(a)}else $("#roster-area ul").append(a)},on_presence:function(a){var b=$(a).attr("from");if(Strophe.getBareJidFromJid(b)===Groupie.room){var c=Strophe.getResourceFromJid(b);if("error"!==$(a).attr("type")||Groupie.joined)if(Groupie.participants[c]||"unavailable"===$(a).attr("type"))Groupie.participants[c]&&"unavailable"===$(a).attr("type")&&($("#participant-list li").each(function(){if(c===
$(this).text())return $(this).remove(),!1}),$(document).trigger("user_left",c));else{var d=$(a).find("item").attr("jid");Groupie.participants[c]=d||!0;remove_roster(d,c);for(var d="",e=0;e<usernamearay.length;e++)if(usernamearay[e].key==c){d=usernamearay[e].value;break}else d=c;""==d&&(d=c);c==Groupie.nickname&&(d=current_username);$("#participant-list").append('<li id="participant-'+c+'"><img src="'+site_url1+'img/online_icon.png" />&nbsp;&nbsp;'+d+"</li>");Groupie.joined&&$(document).trigger("user_joined",
c)}else Groupie.connection.disconnect();"error"!==$(a).attr("type")&&!Groupie.joined&&0<$(a).find("status[code='110']").length&&(0<$(a).find("status[code='210']").length&&(Groupie.nickname=Strophe.getResourceFromJid(b)),$(document).trigger("room_joined"))}return!0},on_public_message:function(a){var b=$(a).attr("from"),c=Strophe.getBareJidFromJid(b),b=Strophe.getResourceFromJid(b);if(c===Groupie.room){var d=!b,c="nick";b===Groupie.nickname&&(c+=" self");var e=$(a).children("body").text(),f=new Date,
g=f.getHours(),h=f.getMinutes(),l=f.getSeconds();switch(f.getDay()){case 1:f="Monday";break;case 2:f="Tuesday";break;case 3:f="Wednesday";break;case 4:f="Thursday";break;case 5:f="Friday";break;case 6:f="Saturday";break;case 7:f="Sunday";break;default:f="error"}10>h&&(h="0"+h);var k="AM";12<=g&&(k="PM",g-=12);0==g&&(g=12);g="<div class='chatdate'>Sent at "+g+":"+h+":"+l+":"+k+" on "+f+"</div>";h=0<$(a).children("delay").length||0<$(a).children("x[xmlns='jabber:x:delay']").length;(a=$(a).children("subject").text())&&
$("#room-topic").text(a);if(d)Groupie.add_message("<div class='notice'>*** Connected</div>");else if(a=h?" delayed":"",d=e.match(/\/me (.*)$/))Groupie.add_message("<div class='message action "+a+"'>* "+b+" "+d[1]+"</div>");else{if(b==cuser)b="me";else for(d=0;d<usernamearay.length;d++)if(usernamearay[d].key==b){b=usernamearay[d].value;break}""!=e&&Groupie.add_message("<div class='message"+a+"'><span class='"+c+"'>"+b+"</span>:&nbsp; <span class='body'>"+e+g+"</span></div>")}}return!0},add_message:function(a){var b=
$("#chat").get(0),c=b.scrollTop>=b.scrollHeight-b.clientHeight;$("#chat").append(a);c&&(b.scrollTop=b.scrollHeight);a=document.getElementById("chat");a.scrollTop=a.scrollHeight;a=Groupie.room.split("@");$("#chatwindowMax"+a[0]+" .mxchat",window.parent.document).is(":visible")&&($("#chatwindowMax"+a[0]+" .mxchat",window.parent.document).hasClass("unread_chat")||$("#chatwindowMax"+a[0]+" .mxchat",window.parent.document).addClass("unread_chat"))},on_private_message:function(a){var b=$(a).attr("from"),
c=Strophe.getBareJidFromJid(b),b=Strophe.getResourceFromJid(b);c===Groupie.room&&(a=$(a).children("body").text(),Groupie.add_message("<div class='message private'>@@ &lt;<span class='nick'>"+b+"</span>&gt; <span class='body'>"+a+"</span> @@</div>"));return!0}};
$(document).ready(function(){$("#leave").click(function(){$("#leave").attr("disabled","disabled");Groupie.connection.send($pres({to:Groupie.room+"/"+Groupie.nickname,type:"unavailable"}));Groupie.connection.disconnect()});$("#input").keypress(function(a){if(13===a.which){a.preventDefault();a=$(this).val();a=replaceImage(a);var b=document.getElementById("chat");b.scrollTop=b.scrollHeight;var b=a.match(/^\/(.*?)(?: (.*))?$/),c=null;b?"msg"===b[1]?(c=b[2].match(/^(.*?) (.*)$/),Groupie.participants[c[1]]?
(Groupie.connection.send($msg({to:Groupie.room+"/"+c[1],type:"chat"}).c("body").t(a)),Groupie.add_message("<div class='message private'>@@ &lt;<span class='nick self'>"+Groupie.nickname+"</span>&gt; <span class='body'>"+c[2]+"</span> @@</div>")):Groupie.add_message("<div class='notice error'>Error: User not in room.</div>")):"me"===b[1]||"action"===b[1]?Groupie.connection.send($msg({to:Groupie.room,type:"groupchat"}).c("body").t("/me "+b[2])):"topic"===b[1]?Groupie.connection.send($msg({to:Groupie.room,
type:"groupchat"}).c("subject").text(b[2])):"kick"===b[1]?Groupie.connection.sendIQ($iq({to:Groupie.room,type:"set"}).c("query",{xmlns:Groupie.NS_MUC+"#admin"}).c("item",{nick:b[2],role:"none"})):"ban"===b[1]?Groupie.connection.sendIQ($iq({to:Groupie.room,type:"set"}).c("query",{xmlns:Groupie.NS_MUC+"#admin"}).c("item",{jid:Groupie.participants[b[2]],affiliation:"outcast"})):"op"===b[1]?Groupie.connection.sendIQ($iq({to:Groupie.room,type:"set"}).c("query",{xmlns:Groupie.NS_MUC+"#admin"}).c("item",
{jid:Groupie.participants[b[2]],affiliation:"admin"})):"deop"===b[1]?Groupie.connection.sendIQ($iq({to:Groupie.room,type:"set"}).c("query",{xmlns:Groupie.NS_MUC+"#admin"}).c("item",{jid:Groupie.participants[b[2]],affiliation:"none"})):Groupie.add_message("<div class='notice error'>Error: Command not recognized.</div>"):Groupie.connection.send($msg({to:Groupie.room,type:"groupchat"}).c("body").t(a));$(this).val("")}}).delay(1E3)});
$(document).bind("connect",function(a,b){Groupie.connection=new Strophe.Connection(bosh_url);Groupie.connection.connect(b.jid,b.password,function(a){if(a===Strophe.Status.CONNECTED){$(document).trigger("connected");var d="connected"}else a===Strophe.Status.DISCONNECTED?(d="disconnected",$(document).trigger("connect",{jid:b.jid,password:b.password})):a===Strophe.Status.ERROR?(d="ERROR",$(document).trigger("connect",{jid:b.jid,password:b.password})):a===Strophe.Status.CONNFAIL&&(d="CONNFAIL",$(document).trigger("connect",
{jid:b.jid,password:b.password}));$.ajax({type:"POST",url:site_url1+"chats/generateGroupConnectionLog",data:{response:d,jid:b.jid}}).done(function(a){})})});
$(document).bind("connected",function(){Groupie.joined=!1;Groupie.participants={};Groupie.connection.addHandler(Groupie.on_presence,null,"presence");Groupie.connection.addHandler(Groupie.on_public_message,null,"message","groupchat");Groupie.connection.addHandler(Groupie.on_private_message,null,"message","chat");Groupie.connection.send($pres({to:Groupie.room+"/"+Groupie.nickname}).c("x",{xmlns:Groupie.NS_MUC}));var a=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});Groupie.connection.sendIQ(a,
Groupie.on_roster);Groupie.connection.addHandler(Groupie.on_roster_changed,"jabber:iq:roster","iq","set")});$(document).bind("disconnected",function(){Groupie.connection=null;$("#room-name").empty();$("#room-topic").empty();$("#participant-list").empty();$("#chat").empty();$("#login_dialog").dialog("open")});$(document).bind("room_joined",function(){Groupie.joined=!0;$("#leave").removeAttr("disabled");$("#room-name").text(Groupie.room);Groupie.add_message("<div class='notice'>*** Room joined.</div>")});
$(document).bind("user_joined",function(a,b){Groupie.add_message("<div class='notice'>*** "+b+" joined.</div>")});$(document).bind("user_left",function(a,b){Groupie.add_message("<div class='notice'>*** "+b+" left.</div>")});
